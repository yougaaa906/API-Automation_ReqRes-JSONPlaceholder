# API automation test pipeline (Auth + Business association)
# Trigger: Push/Pull Request to main branch (production-ready trigger rule)
name: API Automation Test (Auth + Business)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  api-test:
    runs-on: ubuntu-latest
    env:
      TEST_ENV: "test"
      REQRES_MOCK_TOKEN: "mock_token_ci_123456"
    
    steps:
      # Step 1: Checkout repository code (latest version)
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      # Step 2: Set up Python 3.9 (match local dev environment)
      - name: Set Up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # Step 3: Install dependencies (upgrade pip first)
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Create public directory (ensure exists)
      - name: Create Public Directory
        run: mkdir -p ./public/logs

      # Step 5: Execute all API test cases (generate report + logs in public)
      - name: Run All API Tests
        run: |
          pytest tests/ \
            -v \
            --html=${{ env.REPORT_PATH || './public/test-report.html' }} \
            --self-contained-html \
            --tb=short
        env:
          REPORT_PATH: ./public/test-report.html
        continue-on-error: false

      # Step 6: Upload report + logs as artifact (fallback)
      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-automation-artifacts
          path: |
            ./public/test-report.html
            ./public/logs/
          retention-days: 7
          if: always()

      # Step 7: Deploy report + logs to GitHub Pages (online access)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public  # Deploy entire public directory
          publish_branch: gh-pages  # Dedicated branch for online assets
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          keep_files: false  # Overwrite with latest report/logs
        if: always()

      # Step 8: Print online access URLs (key for QA/DevOps)
      - name: Print Online Access URLs
        run: |
          echo "==================== Online Access URLs ===================="
          echo "Test Report: https://${{ github.actor }}.github.io/${{ github.repository }}/test-report.html"
          echo "Latest Log:  https://${{ github.actor }}.github.io/${{ github.repository }}/logs/api_test_latest.log"
          echo "============================================================="
